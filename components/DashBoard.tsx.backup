"use client";

import { DataContext } from "@/Context/DataContext";
import React, { Suspense, useContext, useEffect, useState } from "react";
import Loading from "./Loading";
import { useBranchDataFetch } from "@/hooks/useBranchDataFetch";
import { useBranchFetch } from "@/hooks/useBranchFetch";
import { useSession } from "next-auth/react";
import { useQueryClient } from "@tanstack/react-query";
import { redirect } from "next/navigation";

// Import shadcn/ui chart components
import { ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent } from "@/components/ui/chart";
import { Area, AreaChart, Bar, BarChart, Pie, PieChart, Cell, ResponsiveContainer, XAxis, YAxis, CartesianGrid } from "recharts";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { TrendingUp, DollarSign, Users, ShoppingCart } from "lucide-react";


const DashBoard = () => {
  const queryClient = useQueryClient();
  const { data: session, status } = useSession();
  const isLoading = status === "loading";
  const user = session?.user;
  console.log("ðŸš€ ~ DashBoard ~ user:", user);

  let months = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];

  const [pieBranch, setPieBranch] = useState([]);
  const [revenue, setRevenue] = useState([]);
  const [series, setSeries] = useState([]);
  const [seriesForColChart, setSeriesForColChart] = useState([]);
  const [pieChartData, setPieChartData] = useState({
    salaries: 0,
    bonus: 0,
    revenue: 0,
  });
  const [chartsReady, setChartsReady] = useState(false);

  //////////////////// REDIRECT TO LOGOUT if not USER
  useEffect(() => {
    if (!isLoading && !user) {
      return redirect("/login");
    }
  }, [user, isLoading]);

  //////////////////////

  const {
    data: branchData,
    isLoading: fetchingBranch,
    error: errorInFetchBranch,
    isSuccess,
  } = useBranchFetch(user?.email);
  console.log("ðŸš€ ~ DashBoard ~ branchData:", branchData);

  const [selectedPieBranch, setSelectedPieBranch] = useState(
    branchData?.data?.branch?.companyName || ""
  );
  useEffect(() => {
    if (branchData && branchData.data && branchData.data.branch) {
      setSelectedPieBranch(branchData.data.branch.companyName);
    }
  }, [branchData]);

  const {
    data,
    isLoading: fetchingBranchData,
    error: errorInFetchBranchdData,
  } = useBranchDataFetch(branchData?.data?.branch?._id);

  //// REFETCH when required data changes

  useEffect(() => {
    if (user?.email) {
      const refetch = async () => {
        await queryClient.refetchQueries({
          queryKey: ["branchData"],
          type: "active",
          exact: true,
        });
      };
      refetch();
    }
  }, [user?.email, queryClient]);

  useEffect(() => {
    if (branchData?.data?.branch?._id) {
      const refetch = async () => {
        await queryClient.refetchQueries({
          queryKey: ["dashboardData"],
          type: "active",
          exact: true,
        });
      };
      refetch();
    }
  }, [branchData?.data?.branch?._id, queryClient]);

  ///////////////////Chart Controller Start

  useEffect(() => {
    // Check if data is available before processing
    if (!data?.data?.dashboardData) {
      setChartsReady(false);
      return;
    }

    let branchNames = []; //This is for label in pie chart
    let serie = [];
    let colSeries = [];
    let revenue;

    const currentMonth = new Date().getMonth();

    for (const branchName in data?.data?.dashboardData) {
      const branch = data?.data?.dashboardData[branchName];
      const dashboardData = data?.data?.dashboardData;
      const selectedBranchData =
        dashboardData && dashboardData[selectedPieBranch];
      const piebranch = selectedBranchData && selectedBranchData[currentMonth];

      console.log("ðŸš€ ~ useEffect ~ branch:", piebranch);

      const totalSales = branch && Array.isArray(branch) ?
        branch.map((data) => data?.totalSales || 0) :
        branch && typeof branch === 'object' ?
          Object.values(branch).filter(val => val && typeof val === 'object').map((data) => data?.totalSales || 0) : [];

      const totalRecords = branch && Array.isArray(branch) ?
        branch.map((data) => data?.totalRecords || 0) :
        branch && typeof branch === 'object' ?
          Object.values(branch).filter(val => val && typeof val === 'object').map((data) => data?.totalRecords || 0) : [];

      revenue = totalSales;
      console.log("ðŸš€ ~ useEffect ~ revenue:", revenue);

      let s = {
        name: branchName,
        data: totalSales.length > 0 ? totalSales : [0]
      };
      let colSerie = {
        name: branchName,
        data: totalRecords.length > 0 ? totalRecords : [0]
      };
      branchNames.push(branchName);
      serie.push(s);
      colSeries.push(colSerie);
    }

    const branch = data?.data?.dashboardData[selectedPieBranch]?.[currentMonth];
    revenue = branch?.totalSales;
    console.log("ðŸš€ ~ useEffect ~ revenue:", revenue);

    setPieChartData((prevPieChartData) => ({
      ...prevPieChartData,
      revenue: revenue || 0,
    }));
    setPieBranch(branchNames);
    setSeries(serie.length > 0 ? serie : [{ name: "No Data", data: [0] }]);
    setSeriesForColChart(colSeries.length > 0 ? colSeries : [{ name: "No Data", data: [0] }]);

    // Set charts as ready only when we have valid data
    setChartsReady(serie.length > 0 || colSeries.length > 0);
  }, [
    branchData,
    data?.data?.dashboardData,
    data?.data?.staffData,
    selectedPieBranch,
  ]);

  useEffect(() => {
    const chartController = () => {
      if (data == null) {
        // return;
      }
      console.log(
        "ðŸš€ ~ chartController ~ data?.data?.staffData:",
        data?.data?.staffData
      );

      setPieChartData((prevPieChartData) => ({
        ...prevPieChartData,
        salaries:
          data?.data?.staffData[selectedPieBranch]?.["0"]?.totalSalary || 0,
        bonus: data?.data?.staffData[selectedPieBranch]?.["0"]?.totalBonus || 0,
        // revenue: revenue || 0,
      }));
    };

    chartController();
  }, [data, pieBranch, revenue, selectedPieBranch]);
  console.log("ðŸš€ ~ DashBoard ~ pieBranch:", pieBranch);

  ///////////////////Chart Controller End

  // console.log("ðŸš€ ~ DashBoard ~ months:", months);

  var chartOptions = {
    chart: {
      type: "area",
    },
    yaxis: {
      title: {
        text: "Branch Revenue",
      },
    },
    dataLabels: {
      enabled: false,
    },
    fill: {
      type: "gradient",
      gradient: {
        shadeIntensity: 1,
        opacityFrom: 0.2,
        opacityTo: 0.5,
        stops: [0, 90, 100],
      },
    },
    stroke: {
      curve: "smooth",
      width: 3,
    },

    xaxis: {
      categories: months,
      // categories: chartMonths,
    },
    tooltip: {
      y: {
        formatter: function (val) {
          return val + " MMK";
        },
      },
    },
  };

  var colChartOption = {
    series: seriesForColChart,

    chart: {
      type: "bar",
      height: 350,
    },
    plotOptions: {
      bar: {
        horizontal: false,
        columnWidth: "55%",
        endingShape: "rounded",
      },
    },
    dataLabels: {
      enabled: false,
    },
    stroke: {
      show: true,
      width: 2,
      colors: ["transparent"],
    },
    xaxis: {
      categories: [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ],
    },
    yaxis: {
      title: {
        text: "Customers",
      },
    },
    fill: {
      opacity: 1,
    },
    tooltip: {
      y: {
        formatter: function (val) {
          return val + " Products sold";
        },
      },
    },
  };

  var pieOptions = {
    chart: {
      type: "donut",
    },
    series: [pieChartData.salaries, pieChartData.bonus, pieChartData.revenue],
    labels: ["Salaries", "Bonus", "Revenue"],
    plotOptions: {
      pie: {
        expandOnClick: true,
        donut: {
          labels: {
            show: true,
          },
        },
      },
    },
  };
  return (
    <Suspense fallback={<Loading size="3x" />}>
      <div className="w-full h-full ">
        <div
          id="chart"
          className="drop-shadow-md shadow-md shadow-secondary rounded-lg p-5 select-none"
        >
          {isLoading || fetchingBranch || fetchingBranchData && (<Loading size="5x" />)}

          <div id="firstRow" className="w-full flex items-start">
            <div id="firstCol" className="w-full">
              {" "}
              {series && series.length > 0 && series.some(s => s.data && s.data.length > 0) ? (
                <Chart
                  options={chartOptions}
                  series={series}
                  // series={chartOptions.series}
                  type={chartOptions.chart.type}
                  height={320}
                  className="w-full "
                />
              ) : (
                <div className="flex items-center justify-center h-[320px] text-gray-500">
                  <p>Loading chart data...</p>
                </div>
              )}
            </div>
          </div>

          <div id="secondRow" className="flex items-center">
            <div
              id="firstCol"
              className="w-2/5 border-r-2 border-primary relative"
            >
              {pieOptions.series && pieOptions.series.some(val => val > 0) ? (
                <Chart
                  options={pieOptions}
                  series={pieOptions.series}
                  type={pieOptions.chart.type}
                  // width={700}
                  height={500}
                  className="mt-5 max-h-72"
                />
              ) : (
                <div className="flex items-center justify-center h-72 mt-5 text-gray-500">
                  <p>Loading pie chart data...</p>
                </div>
              )}
              <ul className="flex flex-col gap-2 absolute bottom-0">
                {pieBranch &&
                  pieBranch.map((branchName, index) => (
                    <li key={`branch-${index}-${branchName}`}>
                      <input
                        type="radio"
                        id={branchName}
                        name="branch"
                        value={branchName}
                        className="hidden peer"
                        onChange={(e) => {
                          setSelectedPieBranch(e.target.value);
                          console.log(selectedPieBranch);
                        }}
                        // required
                      />
                      <label
                        for={branchName}
                        className={`inline-flex items-center justify-between w-auto p-2 py-1 text-gray-500 bg-white border border-gray-200 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:text-blue-600 hover:text-gray-600 hover:bg-gray-100 ${
                          selectedPieBranch === branchName
                            ? "border-blue-600 text-blue-600"
                            : ""
                        }`}
                      >
                        <div className="block">
                          <div className="w-full text-sm font-semibold">
                            {branchName}
                          </div>
                        </div>
                      </label>
                    </li>
                  ))}
              </ul>

              <span className=" absolute bottom-1 right-2">
                Monthly overview
              </span>
            </div>
            <div id="secCol" className="w-2/3 max-h-[300px]">
              {" "}
              {colChartOption.series && colChartOption.series.length > 0 &&
               colChartOption.series.some(s => s.data && s.data.length > 0) ? (
                <Chart
                  options={colChartOption}
                  series={colChartOption.series}
                  type="bar"
                  height={320}
                />
              ) : (
                <div className="flex items-center justify-center h-[320px] text-gray-500">
                  <p>Loading column chart data...</p>
                </div>
              )}
            </div>
          </div>
        </div>
        {/* <ExcelHandler /> */}
      </div>
    </Suspense>
  );
};

export default DashBoard;
